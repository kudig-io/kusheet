# Kubernetes 架构全景图 (Architecture Overview)

> **适用版本**: v1.25 - v1.32 | **最后更新**: 2026-01 | **参考**: [Kubernetes Concepts](https://kubernetes.io/docs/concepts/architecture/)

## 目录

1. [架构总览](#1-架构总览)
2. [控制平面详解](#2-控制平面详解)
3. [节点组件详解](#3-节点组件详解)
4. [核心对象模型](#4-核心对象模型)
5. [通信机制](#5-通信机制)
6. [高可用架构](#6-高可用架构)
7. [扩展机制](#7-扩展机制)
8. [安全架构](#8-安全架构)
9. [监控与可观测性](#9-监控与可观测性)
10. [生产实践案例](#10-生产实践案例)

---

## 1. 架构总览

### 1.1 宏观架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    Kubernetes Cluster Architecture                                      │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    Control Plane (Master Nodes)                                  │   │
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                                  API Server Layer                                          │  │   │
│  │  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────┐  │  │   │
│  │  │  │  kube-apiserver │  │  kube-apiserver │  │  kube-apiserver │  │   API Aggregation      │  │  │   │
│  │  │  │    (Instance 1) │  │    (Instance 2) │  │    (Instance 3) │  │   Layer (Metrics,      │  │  │   │
│  │  │  │     :6443       │  │     :6443       │  │     :6443       │  │   Custom APIs)         │  │  │   │
│  │  │  └────────┬───────┘  └────────┬───────┘  └────────┬───────┘  └────────────────────────┘  │  │   │
│  │  │           └──────────────┬─────┴──────────────┬───────┬───────────────────────────────────┘  │   │
│  │  │                          │                    │       │                                       │   │
│  │  │                          ▼                    │       │                                       │   │
│  │  │         ┌────────────────────────────────────┐│       │                                       │   │
│  │  │         │         Load Balancer              ││       │                                       │   │
│  │  │         │   (HAProxy / Nginx / Cloud LB)     ││       │                                       │   │
│  │  │         └────────────────────────────────────┘│       │                                       │   │
│  │  └──────────────────────────────────────────────────────┼────────────────────────────────────────┘  │
│  │                                                           │                                           │
│  │  ┌────────────────────────────────────────────────────────┴──────────────────────────────────────┐  │
│  │  │                                  Core Services Layer                                          │  │
│  │  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────┐  │  │
│  │  │  │  kube-scheduler  │  │kube-controller-  │  │  cloud-controller │  │   Admission          │  │  │
│  │  │  │                  │  │   manager        │  │    -manager       │  │   Controllers        │  │  │
│  │  │  │  - 调度算法       │  │  - Deployment    │  │  - Node          │  │  - Webhooks          │  │  │
│  │  │  │  - 策略执行       │  │  - ReplicaSet    │  │  - Service       │  │  - Policy Engines    │  │  │
│  │  │  │  - 资源分配       │  │  - StatefulSet   │  │  - Route         │  │    (OPA/Gatekeeper)  │  │  │
│  │  │  │  :10259 (HTTPS)  │  │  - DaemonSet     │  │  - Volume        │  │                      │  │  │
│  │  │  │                  │  │  - Job/CronJob   │  │  :10258 (HTTPS)  │  │                      │  │  │
│  │  │  │                  │  │  - Node          │  │                  │  │                      │  │  │
│  │  │  │                  │  │  :10257 (HTTPS)  │  │                  │  │                      │  │  │
│  │  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  └──────────────────────┘  │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│  │                                                           │                                           │
│  │                                                           │ Watch / List (etcd)                       │
│  │                                                           ▼                                           │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │  │                                   Data Store Layer                                              ││
│  │  │  ┌───────────────────────────────────────────────────────────────────────────────────────────┐ ││
│  │  │  │                                    etcd Cluster                                            │ ││
│  │  │  │  ┌──────────────┐       ┌──────────────┐       ┌──────────────┐                          │ ││
│  │  │  │  │   etcd-1     │  ◄──► │   etcd-2     │  ◄──► │   etcd-3     │                          │ ││
│  │  │  │  │              │       │              │       │              │                          │ ││
│  │  │  │  │  :2379 (客户端)│       │  :2379 (客户端)│       │  :2379 (客户端)│                          │ ││
│  │  │  │  │  :2380 (集群) │       │  :2380 (集群) │       │  :2380 (集群) │                          │ ││
│  │  │  │  │              │       │              │       │              │                          │ ││
│  │  │  │  │   Raft 共识   │       │   Raft 共识   │       │   Raft 共识   │                          │ ││
│  │  │  │  │   MVCC 存储   │       │   MVCC 存储   │       │   MVCC 存储   │                          │ ││
│  │  │  │  └──────────────┘       └──────────────┘       └──────────────┘                          │ ││
│  │  │  └───────────────────────────────────────────────────────────────────────────────────────────┘ ││
│  │  └─────────────────────────────────────────────────────────────────────────────────────────────────┘│
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
│                                                           │                                              │
│                                                           │ TLS / gRPC                                   │
│                                                           ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                    Worker Nodes (Data Plane)                                        ││
│  │                                                                                                      ││
│  │  ┌─────────────────────────────────────── Node 1 ────────────────────────────────────────────────┐ ││
│  │  │ ┌────────────────────────────────────────────────────────────────────────────────────────────┐│ ││
│  │  │ │                                 Node Runtime Layer                                         ││ ││
│  │  │ │ ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────────────┐││ ││
│  │  │ │ │   kubelet    │  │ kube-proxy   │  │  Container   │  │       CNI Plugin                 │││ ││
│  │  │ │ │              │  │              │  │   Runtime    │  │   (Calico/Cilium/Flannel)        │││ ││
│  │  │ │ │ - Pod管理     │  │ - iptables   │  │              │  │  - 网络配置                      │││ ││
│  │  │ │ │ - 容器生命周期 │  │ - IPVS       │  │ containerd   │  │  - IP分配 (IPAM)                 │││ ││
│  │  │ │ │ - 健康检查    │  │ - Service LB │  │  or CRI-O    │  │  - 网络策略 (NetworkPolicy)      │││ ││
│  │  │ │ │ - 资源监控    │  │ :10249       │  │              │  │                                  │││ ││
│  │  │ │ │ :10250       │  │              │  │ CRI Interface│  │                                  │││ ││
│  │  │ │ └──────┬───────┘  └──────────────┘  └──────┬───────┘  └──────────────────────────────────┘││ ││
│  │  │ └────────┼──────────────────────────────────┼──────────────────────────────────────────────────┘│ ││
│  │  │          │                                   │                                                  │ ││
│  │  │          ▼                                   ▼                                                  │ ││
│  │  │ ┌────────────────────────────────────────────────────────────────────────────────────────────┐ │ ││
│  │  │ │                                Pod Execution Layer                                         │ │ ││
│  │  │ │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────┐│ │ ││
│  │  │ │  │   Pod 1        │  │   Pod 2        │  │   Pod 3        │  │   Pod N                    ││ │ ││
│  │  │ │  │  ┌──────────┐  │  │  ┌──────────┐  │  │  ┌──────────┐  │  │  ┌──────────┐  ┌──────────┐││ │ ││
│  │  │ │  │  │Container │  │  │  │Container │  │  │  │Container │  │  │  │Container │  │Container │││ │ ││
│  │  │ │  │  │    A     │  │  │  │    B     │  │  │  │    C     │  │  │  │    X     │  │    Y     │││ │ ││
│  │  │ │  │  └──────────┘  │  │  └──────────┘  │  │  └──────────┘  │  │  └──────────┘  └──────────┘││ │ ││
│  │  │ │  │  Network NS    │  │  Network NS    │  │  Network NS    │  │  Network NS                ││ │ ││
│  │  │ │  │  PID NS        │  │  PID NS        │  │  PID NS        │  │  PID NS                    ││ │ ││
│  │  │ │  │  Mount NS      │  │  Mount NS      │  │  Mount NS      │  │  Mount NS                  ││ │ ││
│  │  │ │  │  Cgroup        │  │  Cgroup        │  │  Cgroup        │  │  Cgroup                    ││ │ ││
│  │  │ │  └────────────────┘  └────────────────┘  └────────────────┘  └────────────────────────────┘│ │ ││
│  │  │ └────────────────────────────────────────────────────────────────────────────────────────────┘ │ ││
│  │  │                                                                                                  │ ││
│  │  │ ┌────────────────────────────────────────────────────────────────────────────────────────────┐ │ ││
│  │  │ │                               Storage & Plugins Layer                                      │ │ ││
│  │  │ │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────┐│ │ ││
│  │  │ │  │   CSI Plugin     │  │  Device Plugin   │  │   FlexVolume     │  │   CRI Plugins        ││ │ ││
│  │  │ │  │  (块存储/文件)    │  │  (GPU/RDMA/TPU)  │  │   (遗留)         │  │   (镜像/运行时)       ││ │ ││
│  │  │ │  └──────────────────┘  └──────────────────┘  └──────────────────┘  └──────────────────────┘│ │ ││
│  │  │ └────────────────────────────────────────────────────────────────────────────────────────────┘ │ ││
│  │  └──────────────────────────────────────────────────────────────────────────────────────────────────┘ ││
│  │                                                                                                      ││
│  │  ┌─────────────────────────────────────── Node 2 ────────────────────────────────────────────────┐ ││
│  │  │  (Similar structure as Node 1)                                                                 │ ││
│  │  └────────────────────────────────────────────────────────────────────────────────────────────────┘ ││
│  │                                                                                                      ││
│  │  ┌─────────────────────────────────────── Node N ────────────────────────────────────────────────┐ ││
│  │  │  (Similar structure as Node 1)                                                                 │ ││
│  │  └────────────────────────────────────────────────────────────────────────────────────────────────┘ ││
│  └──────────────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                    Addons & Extensions                                              ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ ││
│  │  │   CoreDNS    │  │  Metrics     │  │  Dashboard   │  │  Ingress     │  │   Service Mesh       │ ││
│  │  │   (DNS)      │  │  Server      │  │   (Web UI)   │  │  Controller  │  │   (Istio/Linkerd)    │ ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────────┘ ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ ││
│  │  │  Monitoring  │  │    Logging   │  │    CI/CD     │  │    Backup    │  │    Security          │ ││
│  │  │ (Prometheus) │  │  (EFK/ELK)   │  │  (ArgoCD)    │  │   (Velero)   │  │  (Falco/Kyverno)     │ ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────────┘ ││
│  └──────────────────────────────────────────────────────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 设计理念与核心原则

| 设计原则 | 描述 | 体现 |
|----------|------|------|
| **声明式 API** | 描述期望状态，由系统驱动到达 | 所有资源都是声明式配置 |
| **控制器模式** | 持续调谐当前状态到期望状态 | Controller Manager 包含40+控制器 |
| **松耦合设计** | 组件通过 API Server 交互 | 组件可独立升级和扩展 |
| **可扩展性** | 插件化架构 | CRI/CNI/CSI/Device Plugin/Admission |
| **自愈能力** | 自动故障检测与恢复 | ReplicaSet/DaemonSet 自动重启 |
| **水平扩展** | 通过副本实现扩展 | HPA/VPA/Cluster Autoscaler |
| **不可变基础设施** | 容器镜像不可变 | 配置变更通过滚动更新 |
| **最终一致性** | 分布式系统一致性模型 | 基于 etcd 的最终一致性 |

### 1.3 分层架构模型

| 层次 | 名称 | 职责 | 关键组件 |
|------|------|------|----------|
| **Layer 1** | 编排层 (Orchestration) | 调度、编排、自动化 | Scheduler, Controllers |
| **Layer 2** | API 层 (API) | 统一入口、认证授权 | API Server, Admission |
| **Layer 3** | 数据层 (Data) | 持久化存储 | etcd |
| **Layer 4** | 运行时层 (Runtime) | 容器运行环境 | kubelet, Container Runtime |
| **Layer 5** | 网络层 (Network) | Pod 网络、Service 负载均衡 | CNI, kube-proxy |
| **Layer 6** | 存储层 (Storage) | 持久化卷管理 | CSI, Volume Plugin |
| **Layer 7** | 扩展层 (Extension) | 自定义功能扩展 | CRD, Operator, Webhook |

---

## 2. 控制平面详解

### 2.1 kube-apiserver

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           kube-apiserver Architecture                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────── Request Flow ───────────────────────────────────┐  │
│  │                                                                            │  │
│  │  1. Client Request (kubectl/controller/kubelet) ──► HTTPS :6443           │  │
│  │                                │                                           │  │
│  │                                ▼                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                    Authentication (认证)                             │  │  │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │  │  │
│  │  │  │ X509 Certs   │ │   Token      │ │   OIDC       │ │  Webhook   │  │  │  │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │  │  │
│  │  └────────────────────────────┬────────────────────────────────────────┘  │  │
│  │                                ▼                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                    Authorization (授权)                              │  │  │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │  │  │
│  │  │  │    RBAC      │ │     ABAC     │ │     Node     │ │  Webhook   │  │  │  │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │  │  │
│  │  └────────────────────────────┬────────────────────────────────────────┘  │  │
│  │                                ▼                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │              Admission Control (准入控制)                            │  │  │
│  │  │                                                                      │  │  │
│  │  │  Mutating Phase:                                                     │  │  │
│  │  │  ┌──────────────────────────────────────────────────────────────┐   │  │  │
│  │  │  │ MutatingAdmissionWebhook → NamespaceLifecycle → ...          │   │  │  │
│  │  │  └──────────────────────────────────────────────────────────────┘   │  │  │
│  │  │                              ▼                                       │  │  │
│  │  │  Validation Phase:                                                   │  │  │
│  │  │  ┌──────────────────────────────────────────────────────────────┐   │  │  │
│  │  │  │ ValidatingAdmissionWebhook → ResourceQuota → LimitRanger ... │   │  │  │
│  │  │  └──────────────────────────────────────────────────────────────┘   │  │  │
│  │  └────────────────────────────┬────────────────────────────────────────┘  │  │
│  │                                ▼                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                    Schema Validation                                 │  │  │
│  │  │         (OpenAPI Schema, CRD Validation)                             │  │  │
│  │  └────────────────────────────┬────────────────────────────────────────┘  │  │
│  │                                ▼                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                      etcd Storage                                    │  │  │
│  │  │   ┌──────────┐      ┌──────────┐      ┌──────────┐                 │  │  │
│  │  │   │  Create  │ ───► │  Update  │ ───► │  Delete  │                 │  │  │
│  │  │   │  (POST)  │      │  (PUT)   │      │ (DELETE) │                 │  │  │
│  │  │   └──────────┘      └──────────┘      └──────────┘                 │  │  │
│  │  │                                                                      │  │  │
│  │  │   - Watch (实时监听资源变化)                                         │  │  │
│  │  │   - List (列出资源)                                                  │  │  │
│  │  │   - Get (获取单个资源)                                               │  │  │
│  │  └──────────────────────────────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 核心功能

| 功能 | 描述 | 实现机制 |
|------|------|----------|
| **RESTful API** | 提供声明式 API | HTTP/HTTPS + JSON/Protobuf |
| **认证** | 验证客户端身份 | X.509/Token/OIDC/Webhook |
| **授权** | 控制访问权限 | RBAC/ABAC/Node/Webhook |
| **准入控制** | 请求拦截与修改 | Mutating/Validating Webhook |
| **数据持久化** | 存储集群状态 | etcd (MVCC + Watch) |
| **API 聚合** | 扩展 API | AA (API Aggregation) |
| **审计日志** | 记录所有操作 | Audit Policy + Backend |
| **限流** | 防止过载 | API Priority and Fairness (APF) |

#### 关键配置参数

| 参数 | 描述 | 推荐值 |
|------|------|--------|
| `--etcd-servers` | etcd 集群地址 | https://etcd1:2379,https://etcd2:2379,https://etcd3:2379 |
| `--bind-address` | 监听地址 | 0.0.0.0 (生产环境使用内网 IP) |
| `--secure-port` | HTTPS 端口 | 6443 |
| `--enable-admission-plugins` | 启用准入插件 | NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,PodSecurity |
| `--authorization-mode` | 授权模式 | Node,RBAC |
| `--client-ca-file` | 客户端 CA 证书 | /etc/kubernetes/pki/ca.crt |
| `--tls-cert-file` | TLS 证书 | /etc/kubernetes/pki/apiserver.crt |
| `--tls-private-key-file` | TLS 私钥 | /etc/kubernetes/pki/apiserver.key |
| `--service-cluster-ip-range` | Service CIDR | 10.96.0.0/12 |
| `--service-account-key-file` | SA 公钥 | /etc/kubernetes/pki/sa.pub |
| `--kubelet-client-certificate` | Kubelet 客户端证书 | /etc/kubernetes/pki/apiserver-kubelet-client.crt |

### 2.2 etcd

#### 架构与特性

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              etcd Cluster Architecture                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │                         Raft Consensus Layer                           │     │
│  │  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐           │     │
│  │  │   Leader     │ ──► │   Follower   │     │   Follower   │           │     │
│  │  │   (etcd-1)   │     │   (etcd-2)   │     │   (etcd-3)   │           │     │
│  │  │              │ ◄── │              │ ──► │              │           │     │
│  │  │  :2379/:2380 │     │  :2379/:2380 │     │  :2379/:2380 │           │     │
│  │  └──────────────┘     └──────────────┘     └──────────────┘           │     │
│  │                                                                         │     │
│  │  - Leader Election (Leader 选举)                                       │     │
│  │  - Log Replication (日志复制)                                          │     │
│  │  - Quorum (法定人数: 2f+1, 最少3节点)                                   │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │                            MVCC Storage                                 │     │
│  │  ┌───────────────────────────────────────────────────────────────────┐ │     │
│  │  │  Key-Value Store (B+ Tree)                                        │ │     │
│  │  │  ┌────────────┬─────────────────┬──────────────┬────────────────┐│ │     │
│  │  │  │   Key      │  Revision       │   Value      │   Lease TTL    ││ │     │
│  │  │  ├────────────┼─────────────────┼──────────────┼────────────────┤│ │     │
│  │  │  │ /registry/ │  1000 → 1005    │  JSON/Proto  │   N/A          ││ │     │
│  │  │  │  pods/...  │  (版本链)       │              │                ││ │     │
│  │  │  └────────────┴─────────────────┴──────────────┴────────────────┘│ │     │
│  │  │                                                                   │ │     │
│  │  │  - Multi-Version Concurrency Control (多版本并发控制)             │ │     │
│  │  │  - Watch 机制 (基于 Revision 变化推送)                            │ │     │
│  │  │  - Compaction (压缩历史版本)                                      │ │     │
│  │  └───────────────────────────────────────────────────────────────────┘ │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

| 特性 | 描述 | 技术细节 |
|------|------|----------|
| **Raft 共识** | 保证一致性 | Leader/Follower/Candidate 角色切换 |
| **MVCC** | 多版本控制 | 保留历史版本，支持 Watch |
| **Watch** | 实时监听 | 基于 Revision 推送变化 |
| **Lease** | 租约机制 | 支持 TTL，用于心跳 |
| **事务** | 原子操作 | Compare-And-Swap (CAS) |
| **快照备份** | 数据备份 | etcdctl snapshot save |
| **水平扩展** | 只读副本 | Learner 模式 (非投票成员) |

#### 数据存储结构

```
/registry/
├── pods/
│   ├── default/nginx-xxx         → Pod 对象
│   └── kube-system/coredns-xxx   → Pod 对象
├── deployments/
│   └── default/nginx             → Deployment 对象
├── services/
│   └── default/kubernetes        → Service 对象
├── nodes/
│   ├── node-1                    → Node 对象
│   └── node-2                    → Node 对象
├── secrets/
│   └── default/my-secret         → Secret 对象 (加密存储)
└── events/
    └── default/nginx-xxx.event   → Event 对象

# 每个对象存储格式 (简化)
{
  "apiVersion": "v1",
  "kind": "Pod",
  "metadata": {
    "name": "nginx-xxx",
    "namespace": "default",
    "resourceVersion": "1005",  # etcd Revision
    "uid": "12345678-1234-1234-1234-123456789012"
  },
  "spec": {...},
  "status": {...}
}
```

### 2.3 kube-scheduler

#### 调度流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Scheduling Framework Workflow                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────────── Scheduling Cycle ──────────────────────────┐   │
│  │                                                                           │   │
│  │  1. Pod 进入 SchedulingQueue (优先级队列)                                │   │
│  │                     │                                                     │   │
│  │                     ▼                                                     │   │
│  │  2. PreFilter Phase (预过滤)                                             │   │
│  │     ├── NodeResourcesFit: 计算资源需求                                   │   │
│  │     └── PreFilter Plugins ...                                            │   │
│  │                     │                                                     │   │
│  │                     ▼                                                     │   │
│  │  3. Filter Phase (过滤不可用节点)                                        │   │
│  │     ├── NodeUnschedulable: 节点不可调度检查                              │   │
│  │     ├── NodeResourcesFit: 资源是否满足                                   │   │
│  │     ├── NodeAffinity: 节点亲和性                                         │   │
│  │     ├── PodTopologySpread: 拓扑分布                                      │   │
│  │     ├── TaintToleration: 污点容忍                                        │   │
│  │     └── VolumeBinding: 存储卷绑定                                        │   │
│  │                     │                                                     │   │
│  │                     ▼                                                     │   │
│  │  4. PostFilter Phase (如果所有节点被过滤)                                │   │
│  │     └── Preemption: 抢占低优先级 Pod                                     │   │
│  │                     │                                                     │   │
│  │                     ▼                                                     │   │
│  │  5. PreScore Phase (评分前处理)                                          │   │
│  │                     │                                                     │   │
│  │                     ▼                                                     │   │
│  │  6. Score Phase (为候选节点打分)                                         │   │
│  │     ├── NodeResourcesBalancedAllocation: 资源均衡                        │   │
│  │     ├── ImageLocality: 镜像本地性                                        │   │
│  │     ├── InterPodAffinity: Pod 间亲和性                                   │   │
│  │     └── PodTopologySpread: 拓扑分布评分                                  │   │
│  │                     │                                                     │   │
│  │                     ▼                                                     │   │
│  │  7. NormalizeScore (归一化到 0-100)                                      │   │
│  │                     │                                                     │   │
│  │                     ▼                                                     │   │
│  │  8. Select Best Node (选择最高分节点)                                    │   │
│  │                     │                                                     │   │
│  │                     ▼                                                     │   │
│  │  9. Reserve Phase (预留资源)                                             │   │
│  │                     │                                                     │   │
│  └─────────────────────┼──────────────────────────────────────────────────────┘   │
│                        │                                                         │
│  ┌─────────────────────┼──────────────── Binding Cycle ───────────────────────┐  │
│  │                     ▼                                                       │  │
│  │  10. Permit Phase (批准/拒绝/等待)                                         │  │
│  │                     │                                                       │  │
│  │                     ▼                                                       │  │
│  │  11. PreBind Phase (绑定前准备)                                            │  │
│  │      └── VolumeBinding: PV 绑定                                            │  │
│  │                     │                                                       │  │
│  │                     ▼                                                       │  │
│  │  12. Bind Phase (绑定 Pod 到节点)                                          │  │
│  │      └── DefaultBinder: 更新 Pod.spec.nodeName                             │  │
│  │                     │                                                       │  │
│  │                     ▼                                                       │  │
│  │  13. PostBind Phase (绑定后处理)                                           │  │
│  │                                                                             │  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘
```

#### 调度策略

| 策略类型 | 插件 | 功能 | 应用场景 |
|----------|------|------|----------|
| **资源分配** | NodeResourcesFit | 检查 CPU/内存/GPU 是否满足 | 基础调度 |
| **亲和性** | NodeAffinity | 节点标签匹配 | 指定机型/可用区 |
| **反亲和性** | InterPodAntiAffinity | Pod 分散部署 | 高可用 |
| **拓扑分布** | PodTopologySpread | 跨可用区均衡 | 容错 |
| **污点容忍** | TaintToleration | 节点污点与 Pod 容忍 | 专用节点 |
| **优先级** | PriorityClass | 高优先级 Pod 抢占 | 关键业务 |
| **资源评分** | LeastAllocated | 选择资源最空闲节点 | 负载均衡 |
| **镜像本地性** | ImageLocality | 优先选择已有镜像节点 | 加速启动 |

### 2.4 kube-controller-manager

#### 内置控制器

| 控制器 | 职责 | 调谐逻辑 | 关键参数 |
|--------|------|----------|----------|
| **Deployment** | 管理 ReplicaSet | 滚动更新、回滚 | maxSurge, maxUnavailable |
| **ReplicaSet** | 维持 Pod 副本数 | 创建/删除 Pod | replicas |
| **StatefulSet** | 有状态应用 | 顺序创建/删除 | podManagementPolicy |
| **DaemonSet** | 每节点一个 Pod | 节点变化时调整 | updateStrategy |
| **Job** | 批处理任务 | 运行到完成 | completions, parallelism |
| **CronJob** | 定时任务 | 定时创建 Job | schedule |
| **Node** | 节点生命周期 | 驱逐不健康节点 Pod | node-eviction-rate |
| **ServiceAccount** | 自动创建 SA | 注入 Token | service-account-private-key-file |
| **Namespace** | 命名空间生命周期 | 级联删除资源 | concurrent-namespace-syncs |
| **PersistentVolume** | PV 绑定 | PV/PVC 匹配 | pv-recycler-pod-template-filepath-nfs |
| **EndpointSlice** | Service 端点 | 更新后端 Pod IP | concurrent-endpoint-syncs |
| **ResourceQuota** | 资源配额 | 限制命名空间资源 | quota-resync-period |
| **HorizontalPodAutoscaler** | 水平扩缩容 | 根据指标调整副本 | horizontal-pod-autoscaler-sync-period |
| **TTLAfterFinished** | 清理已完成 Job | 定时删除 | ttl-seconds-after-finished |

#### Leader 选举机制

```yaml
# Controller Manager Leader 选举配置
apiVersion: v1
kind: Endpoints
metadata:
  name: kube-controller-manager
  namespace: kube-system
  annotations:
    control-plane.alpha.kubernetes.io/leader: |
      {
        "holderIdentity": "master-1_xxxxx",
        "leaseDurationSeconds": 15,
        "acquireTime": "2026-01-20T10:00:00Z",
        "renewTime": "2026-01-20T10:00:10Z",
        "leaderTransitions": 0
      }
```

| 参数 | 描述 | 默认值 |
|------|------|--------|
| `--leader-elect` | 启用 Leader 选举 | true |
| `--leader-elect-lease-duration` | Lease 持续时间 | 15s |
| `--leader-elect-renew-deadline` | 续约截止时间 | 10s |
| `--leader-elect-retry-period` | 重试周期 | 2s |
| `--leader-elect-resource-name` | 资源名称 | kube-controller-manager |

### 2.5 cloud-controller-manager

#### 云平台集成

| 云平台 | CCM 实现 | 功能 |
|--------|----------|------|
| **AWS** | cloud-provider-aws | Node/Service/Route Controller |
| **Azure** | cloud-provider-azure | Node/Service/Route Controller |
| **GCP** | cloud-provider-gcp | Node/Service/Route Controller |
| **阿里云** | cloud-provider-alibaba-cloud | Node/Service/Route Controller |
| **OpenStack** | cloud-provider-openstack | Node/Service/Route Controller |

#### 核心控制器

| 控制器 | 职责 | 云平台操作 |
|--------|------|------------|
| **Node Controller** | 节点生命周期管理 | 查询云平台实例状态、添加节点标签 (zone/region/instance-type) |
| **Service Controller** | LoadBalancer Service | 创建/删除云负载均衡器 |
| **Route Controller** | Pod 网络路由 | 配置 VPC 路由表 |
| **Volume Controller** | 云盘挂载 | Attach/Detach 云盘 (已废弃，迁移到 CSI) |

---

## 3. 节点组件详解

### 3.1 kubelet

#### 核心功能架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              kubelet Architecture                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────── API Server Communication ──────────────────────┐   │
│  │  - Watch Pods assigned to this node                                      │   │
│  │  - Report Node/Pod status                                                │   │
│  │  - Certificate rotation                                                  │   │
│  └────────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                             │
│                                    ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                          kubelet Core Modules                            │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                    Pod Lifecycle Manager                          │   │    │
│  │  │  - syncPod() - 核心调谐循环                                       │   │    │
│  │  │  - Pod 创建/更新/删除                                             │   │    │
│  │  │  - Init Containers → Main Containers → Sidecar Containers       │   │    │
│  │  │  - PreStop Hook → Termination Grace Period                       │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                    PLEG (Pod Lifecycle Event Generator)          │   │    │
│  │  │  - 监听容器运行时事件                                             │   │    │
│  │  │  - 生成 Pod 状态变化事件                                          │   │    │
│  │  │  - 触发 syncPod                                                   │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                    Probe Manager                                  │   │    │
│  │  │  - Liveness Probe (存活探测)                                      │   │    │
│  │  │  - Readiness Probe (就绪探测)                                     │   │    │
│  │  │  - Startup Probe (启动探测)                                       │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                    Volume Manager                                 │   │    │
│  │  │  - Volume Mount/Unmount                                           │   │    │
│  │  │  - CSI Plugin 交互                                                │   │    │
│  │  │  - Secret/ConfigMap 挂载                                          │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                    Status Manager                                 │   │    │
│  │  │  - 收集 Pod/Container 状态                                        │   │    │
│  │  │  - 同步到 API Server                                              │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                    Eviction Manager                               │   │    │
│  │  │  - 监控节点资源压力                                               │   │    │
│  │  │  - 驱逐 Pod (内存/磁盘/inode 压力)                                │   │    │
│  │  │  - Hard Eviction / Soft Eviction                                 │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                    cAdvisor (Container Advisor)                   │   │    │
│  │  │  - 容器资源使用监控                                               │   │    │
│  │  │  - CPU/内存/网络/磁盘 I/O                                         │   │    │
│  │  │  - 提供 /metrics 端点                                             │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                    │                                             │
│                                    ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                          CRI (Container Runtime Interface)               │    │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │    │
│  │  │  RuntimeService:                                                    │ │    │
│  │  │  - RunPodSandbox / StopPodSandbox                                  │ │    │
│  │  │  - CreateContainer / StartContainer / StopContainer                │ │    │
│  │  │  - RemoveContainer / ListContainers                                │ │    │
│  │  │  - Exec / Attach / PortForward                                     │ │    │
│  │  │                                                                     │ │    │
│  │  │  ImageService:                                                      │ │    │
│  │  │  - PullImage / RemoveImage / ListImages                            │ │    │
│  │  └────────────────────────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                    │                                             │
│                                    ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    Container Runtime (containerd/CRI-O)                  │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │    │
│  │  │   runc      │  │   crun      │  │   gVisor    │ ... (OCI Runtime)   │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                     │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 关键配置参数

| 参数 | 描述 | 推荐值 |
|------|------|--------|
| `--kubeconfig` | API Server 配置 | /etc/kubernetes/kubelet.conf |
| `--pod-manifest-path` | 静态 Pod 路径 | /etc/kubernetes/manifests |
| `--container-runtime-endpoint` | CRI Socket | unix:///run/containerd/containerd.sock |
| `--cgroup-driver` | cgroup 驱动 | systemd (与 runtime 一致) |
| `--eviction-hard` | 硬驱逐阈值 | memory.available<100Mi,nodefs.available<10% |
| `--eviction-soft` | 软驱逐阈值 | memory.available<200Mi,nodefs.available<15% |
| `--eviction-soft-grace-period` | 软驱逐宽限期 | memory.available=1m30s |
| `--max-pods` | 单节点最大 Pod 数 | 110 (云平台可能更高) |
| `--pod-infra-container-image` | pause 镜像 | registry.k8s.io/pause:3.9 |
| `--cluster-dns` | CoreDNS IP | 10.96.0.10 |
| `--cluster-domain` | 集群域名 | cluster.local |

### 3.2 kube-proxy

#### 工作模式对比

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         kube-proxy Mode Comparison                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────── iptables Mode ────────────────────────────────┐    │
│  │  Client ──► Service VIP ──► iptables NAT ──► Random Backend Pod         │    │
│  │                                                                           │    │
│  │  优点: 简单、兼容性好                                                     │    │
│  │  缺点: 性能差 (O(n) 规则匹配)、无法均衡负载、规则更新慢                  │    │
│  │  适用: 小规模集群 (<1000 Service)                                        │    │
│  └───────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌────────────────────────── IPVS Mode ──────────────────────────────────────┐  │
│  │  Client ──► Service VIP ──► IPVS (LVS) ──► Load Balanced Backend Pod     │  │
│  │                                                                            │  │
│  │  优点: 高性能 (O(1) 哈希表)、支持多种负载均衡算法、规则更新快            │  │
│  │  缺点: 需要内核模块 (ip_vs)                                               │  │
│  │  适用: 大规模集群 (>1000 Service)                                         │  │
│  │  算法: rr (轮询), lc (最少连接), dh (目标哈希), sh (源哈希), sed (最短期望延迟) │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  ┌────────────────────────── eBPF Mode (Cilium) ──────────────────────────────┐ │
│  │  Client ──► XDP/TC eBPF ──► Socket Redirect ──► Backend Pod (Bypass TCP/IP)│ │
│  │                                                                             │ │
│  │  优点: 最高性能、内核旁路、L7 感知、集成 NetworkPolicy                     │ │
│  │  缺点: 需要新内核 (>= 4.19)、复杂度高                                      │ │
│  │  适用: 高性能场景、Service Mesh                                            │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

| 模式 | 延迟 | 吞吐量 | CPU 消耗 | Service 规模 | 推荐场景 |
|------|------|--------|----------|--------------|----------|
| **iptables** | 高 | 低 | 高 | <1000 | 小规模/兼容性 |
| **IPVS** | 中 | 高 | 中 | >1000 | 大规模生产 |
| **eBPF** | 最低 | 最高 | 最低 | 无限制 | 高性能/新内核 |

#### IPVS 配置示例

```yaml
# kube-proxy ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-proxy
  namespace: kube-system
data:
  config.conf: |
    apiVersion: kubeproxy.config.k8s.io/v1alpha1
    kind: KubeProxyConfiguration
    mode: ipvs
    ipvs:
      scheduler: rr  # rr, lc, dh, sh, sed
      strictARP: true  # 启用严格 ARP (配合 MetalLB)
      syncPeriod: 30s
      minSyncPeriod: 5s
    iptables:
      masqueradeAll: false
      masqueradeBit: 14
      minSyncPeriod: 0s
      syncPeriod: 30s
    clusterCIDR: 10.244.0.0/16
    metricsBindAddress: 0.0.0.0:10249
```

### 3.3 容器运行时

#### 运行时演进

```
Docker (Monolithic) ──► containerd (Modular) ──► CRI-O (Lightweight)
        │                       │                       │
        ├─ dockerd              ├─ containerd           ├─ CRI-O
        ├─ containerd           │                       │
        └─ runc                 └─ runc                 └─ runc

Kubernetes 1.24+ 移除 dockershim，推荐:
- containerd (通用)
- CRI-O (Kubernetes 专用)
```

| 运行时 | 优点 | 缺点 | 适用场景 |
|--------|------|------|----------|
| **containerd** | 轻量、性能好、生态丰富 | 调试工具少 (需 nerdctl) | 通用生产 |
| **CRI-O** | 极简、Kubernetes 原生 | 功能有限 | Kubernetes 专用 |
| **Docker** | 生态最好、调试方便 | 笨重 (需 cri-dockerd) | 开发环境 |

---

## 4. 核心对象模型

### 4.1 Kubernetes 对象层次

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       Kubernetes Object Hierarchy                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌───────────────────────────── Cluster Scope ──────────────────────────────┐   │
│  │                                                                           │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐│   │
│  │  │    Node     │  │ Namespace   │  │ StorageClass│  │ ClusterRole     ││   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘│   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐│   │
│  │  │PersistentVol│  │  PriorityClass │ │CertSignReq  │  │CustomResDefn    ││   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘│   │
│  └───────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌───────────────────────────── Namespace Scope ────────────────────────────┐   │
│  │                                                                           │   │
│  │  Workload Resources (工作负载资源)                                       │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌───────────────────┐ │   │
│  │  │    Pod     │  │ ReplicaSet │  │ Deployment │  │   StatefulSet     │ │   │
│  │  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └────────┬──────────┘ │   │
│  │        │                │                │                 │            │   │
│  │        │                └────────────────┴─────────────────┘            │   │
│  │        │                         ▼                                      │   │
│  │        │                    管理 Pod 副本                               │   │
│  │        │                                                                │   │
│  │  ┌────┴──────┐  ┌────────────┐  ┌────────────┐  ┌───────────────────┐ │   │
│  │  │ DaemonSet │  │    Job     │  │  CronJob   │  │   ReplicationCtl  │ │   │
│  │  └───────────┘  └────────────┘  └────────────┘  └───────────────────┘ │   │
│  │                                                                         │   │
│  │  Service Resources (服务资源)                                          │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌───────────────────┐ │   │
│  │  │  Service   │  │  Endpoints │  │EndpointSlice│  │      Ingress      │ │   │
│  │  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └───────────────────┘ │   │
│  │        │                │                │                              │   │
│  │        └────────────────┴────────────────┘                              │   │
│  │                          ▼                                              │   │
│  │                    负载均衡到 Pod                                       │   │
│  │                                                                         │   │
│  │  Config & Storage (配置与存储)                                         │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌───────────────────┐ │   │
│  │  │ ConfigMap  │  │   Secret   │  │     PVC    │  │   ServiceAccount  │ │   │
│  │  └────────────┘  └────────────┘  └────────────┘  └───────────────────┘ │   │
│  │                                                                         │   │
│  │  Policy & RBAC (策略与权限)                                            │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌───────────────────┐ │   │
│  │  │ NetworkPolicy│ │    Role    │  │ RoleBinding│  │  ResourceQuota    │ │   │
│  │  └────────────┘  └────────────┘  └────────────┘  └───────────────────┘ │   │
│  └───────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 对象元数据结构

```yaml
# 标准 Kubernetes 对象结构
apiVersion: apps/v1      # API 组/版本
kind: Deployment         # 资源类型
metadata:                # 元数据
  name: nginx-deployment
  namespace: default
  labels:                # 标签 (用于选择器)
    app: nginx
    environment: production
  annotations:           # 注解 (用于存储非标识性信息)
    description: "Nginx web server"
    deployment.kubernetes.io/revision: "3"
  ownerReferences:       # 所有者引用 (级联删除)
  - apiVersion: apps/v1
    kind: ReplicaSet
    name: nginx-deployment-xxx
    uid: xxx
    controller: true
    blockOwnerDeletion: true
  finalizers:            # 终结器 (删除前执行清理)
  - kubernetes.io/pvc-protection
  resourceVersion: "1234567"  # etcd Revision (乐观并发控制)
  generation: 5              # spec 修改次数
  creationTimestamp: "2026-01-20T10:00:00Z"
  uid: "12345678-1234-1234-1234-123456789012"
spec:                    # 期望状态
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
        ports:
        - containerPort: 80
status:                  # 当前状态 (由 Controller 更新)
  replicas: 3
  availableReplicas: 3
  readyReplicas: 3
  conditions:
  - type: Available
    status: "True"
    lastUpdateTime: "2026-01-20T10:01:00Z"
    lastTransitionTime: "2026-01-20T10:00:30Z"
    reason: MinimumReplicasAvailable
    message: "Deployment has minimum availability."
```

### 4.3 Pod 生命周期

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Pod Lifecycle Phases                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │  1. Pending (等待)                                                        │   │
│  │     - API Server 已创建 Pod 对象                                          │   │
│  │     - 等待 Scheduler 调度                                                 │   │
│  │     - 等待镜像拉取                                                        │   │
│  │     - 等待存储卷挂载                                                      │   │
│  └────────────────────────────┬──────────────────────────────────────────────┘   │
│                                ▼                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │  2. Creating (创建中)                                                     │   │
│  │     a. kubelet 接收 Pod 分配                                              │   │
│  │     b. 创建 Pod Sandbox (pause 容器)                                      │   │
│  │        └── 创建 Network Namespace                                         │   │
│  │        └── 调用 CNI 配置网络                                              │   │
│  │     c. 拉取镜像 (如未缓存)                                                │   │
│  │     d. 创建 Init Containers (按顺序)                                      │   │
│  │        └── InitContainer-1 → InitContainer-2 → ...                        │   │
│  │     e. 创建 Main Containers (并行)                                        │   │
│  └────────────────────────────┬──────────────────────────────────────────────┘   │
│                                ▼                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │  3. Running (运行中)                                                      │   │
│  │     - 至少一个容器在运行                                                  │   │
│  │     - Startup Probe (启动探测) → 成功后开始其他探测                      │   │
│  │     - Liveness Probe (存活探测) → 失败则重启容器                         │   │
│  │     - Readiness Probe (就绪探测) → 失败则从 Service 移除                 │   │
│  │     - PostStart Hook 执行                                                 │   │
│  └────────────────────────────┬──────────────────────────────────────────────┘   │
│                                │                                                 │
│                  ┌─────────────┴─────────────┐                                   │
│                  │                           │                                   │
│                  ▼                           ▼                                   │
│  ┌────────────────────────────────┐  ┌──────────────────────────────────────┐   │
│  │  4a. Succeeded (成功完成)      │  │  4b. Failed (失败)                   │   │
│  │      - 所有容器正常退出 (0)    │  │      - 容器异常退出 (非0)            │   │
│  │      - restartPolicy: Never    │  │      - restartPolicy:                │   │
│  │                                │  │        Always/OnFailure → 重启       │   │
│  │                                │  │        Never → 保持 Failed           │   │
│  └────────────────────────────────┘  └──────────────────────────────────────┘   │
│                  │                           │                                   │
│                  └─────────────┬─────────────┘                                   │
│                                ▼                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │  5. Terminating (终止中)                                                  │   │
│  │     a. PreStop Hook 执行 (同时进行)                                       │   │
│  │     b. SIGTERM 信号发送给容器                                             │   │
│  │     c. 等待 terminationGracePeriodSeconds (默认30s)                       │   │
│  │     d. 超时后发送 SIGKILL 强制终止                                        │   │
│  │     e. 清理网络、存储卷                                                   │   │
│  └────────────────────────────┬──────────────────────────────────────────────┘   │
│                                ▼                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │  6. Completed / Unknown                                                   │   │
│  │     - Completed: Pod 已终止 (不会重启)                                    │   │
│  │     - Unknown: 节点失联，Pod 状态未知                                     │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### Pod 状态条件 (Conditions)

| Condition Type | True 含义 | False 含义 |
|----------------|-----------|------------|
| **PodScheduled** | Pod 已调度到节点 | 等待调度 |
| **Initialized** | 所有 Init Container 完成 | Init Container 运行中 |
| **ContainersReady** | 所有容器就绪 | 容器未就绪 |
| **Ready** | Pod 就绪 (可接收流量) | Pod 未就绪 |

---

## 5. 通信机制

### 5.1 组件间通信

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       Component Communication Matrix                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                    API Server (中心化通信)                               │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                     etcd (唯一写入者)                             │   │    │
│  │  │  - API Server ──► etcd (gRPC :2379)                              │   │    │
│  │  │  - TLS 双向认证                                                  │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                   Scheduler (Watch API)                           │   │    │
│  │  │  - Scheduler ──Watch──► API Server                               │   │    │
│  │  │  - Scheduler ──Bind──► API Server (更新 Pod.spec.nodeName)       │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │              Controller Manager (Watch API)                       │   │    │
│  │  │  - CM ──Watch──► API Server (监听资源变化)                       │   │    │
│  │  │  - CM ──Update──► API Server (更新资源状态)                      │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                    kubelet (双向通信)                             │   │    │
│  │  │  - kubelet ──Watch──► API Server (获取 Pod 分配)                 │   │    │
│  │  │  - kubelet ──Update──► API Server (上报 Node/Pod 状态)           │   │    │
│  │  │  - API Server ──HTTPS──► kubelet :10250 (Exec/Logs/PortForward) │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                          │    │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │    │
│  │  │                   kube-proxy (Watch API)                          │   │    │
│  │  │  - kube-proxy ──Watch──► API Server (Service/Endpoints/Nodes)    │   │    │
│  │  └──────────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 认证与授权流程

| 步骤 | 阶段 | 机制 | 示例 |
|------|------|------|------|
| **1. 认证** | Authentication | X.509 证书/Bearer Token | kubectl (客户端证书) |
| **2. 授权** | Authorization | RBAC (Role-Based Access Control) | ClusterRole/RoleBinding |
| **3. 准入控制** | Admission Control | Mutating/Validating Webhook | 注入 Sidecar/策略验证 |
| **4. 持久化** | Storage | etcd | 保存到 /registry/pods/... |

### 5.3 Watch 机制详解

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Watch Mechanism Flow                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  1. Client (Controller) 发起 Watch 请求                                         │
│     GET /api/v1/pods?watch=true&resourceVersion=1000                            │
│                                │                                                 │
│                                ▼                                                 │
│  2. API Server 创建 Watch Stream (HTTP Chunked Transfer)                        │
│                                │                                                 │
│                                ▼                                                 │
│  3. API Server 从 etcd Watch 资源变化                                           │
│     etcd.Watch("/registry/pods/", WithRev(1001))                                │
│                                │                                                 │
│                                ▼                                                 │
│  4. etcd 检测到变化 (Revision 1001 → 1002)                                      │
│     - Event Type: ADDED / MODIFIED / DELETED / BOOKMARK                         │
│     - Object: Pod 对象                                                          │
│                                │                                                 │
│                                ▼                                                 │
│  5. API Server 推送 Event 到 Client                                             │
│     {                                                                            │
│       "type": "MODIFIED",                                                        │
│       "object": {"kind": "Pod", "metadata": {"resourceVersion": "1002"}, ...}   │
│     }                                                                            │
│                                │                                                 │
│                                ▼                                                 │
│  6. Client 处理 Event                                                            │
│     - 更新本地缓存 (Informer)                                                    │
│     - 触发 EventHandler                                                          │
│     - 调谐逻辑 (Reconcile)                                                       │
│                                                                                  │
│  7. 如果连接断开 (网络/超时)                                                     │
│     - Client 重连                                                                │
│     - 使用最后的 resourceVersion 继续 Watch                                      │
│     - 如果 resourceVersion 过期 (etcd 已 Compact)                               │
│       └── List 全量数据重新同步                                                 │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### Watch 关键参数

| 参数 | 描述 | 示例 |
|------|------|------|
| `watch=true` | 启用 Watch | `?watch=true` |
| `resourceVersion` | 起始版本 | `?resourceVersion=1000` |
| `timeoutSeconds` | 超时时间 | `?timeoutSeconds=600` |
| `allowWatchBookmarks` | 允许 Bookmark | `?allowWatchBookmarks=true` |

---

## 6. 高可用架构

### 6.1 控制平面高可用部署

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       HA Control Plane Architecture                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────── External Load Balancer ────────────────────────┐   │
│  │                                                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │   │
│  │  │  HAProxy / Nginx / Cloud LB (健康检查 :6443/healthz)                │ │   │
│  │  │  VIP: 192.168.1.100:6443                                             │ │   │
│  │  └─────────────────────────────────────────────────────────────────────┘ │   │
│  └────────────────────────────┬──────────────────────────────────────────────┘   │
│                                │                                                 │
│                  ┌─────────────┼─────────────┬───────────────┐                   │
│                  │             │             │               │                   │
│                  ▼             ▼             ▼               ▼                   │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────────────────────┐ │
│  │   Master-1       │ │   Master-2       │ │   Master-3                       │ │
│  │                  │ │                  │ │                                  │ │
│  │ ┌──────────────┐ │ │ ┌──────────────┐ │ │ ┌──────────────┐                │ │
│  │ │ kube-apiserver│ │ │ │kube-apiserver│ │ │ │kube-apiserver│ (Active-Active)│ │
│  │ │   (Active)   │ │ │ │   (Active)   │ │ │ │   (Active)   │                │ │
│  │ └──────────────┘ │ │ └──────────────┘ │ │ └──────────────┘                │ │
│  │                  │ │                  │ │                                  │ │
│  │ ┌──────────────┐ │ │ ┌──────────────┐ │ │ ┌──────────────┐                │ │
│  │ │kube-scheduler│ │ │ │kube-scheduler│ │ │ │kube-scheduler│                │ │
│  │ │  (Leader)    │◄├─┤►│  (Standby)   │◄├─┤►│  (Standby)   │ (Leader Election)│
│  │ └──────────────┘ │ │ └──────────────┘ │ │ └──────────────┘                │ │
│  │                  │ │                  │ │                                  │ │
│  │ ┌──────────────┐ │ │ ┌──────────────┐ │ │ ┌──────────────┐                │ │
│  │ │kube-controller│ │ │ │kube-controller│ │ │ │kube-controller│               │ │
│  │ │  -manager    │◄├─┤►│  -manager    │◄├─┤►│  -manager    │ (Leader Election)│
│  │ │  (Leader)    │ │ │ │  (Standby)   │ │ │ │  (Standby)   │                │ │
│  │ └──────────────┘ │ │ └──────────────┘ │ │ └──────────────┘                │ │
│  │                  │ │                  │ │                                  │ │
│  │ ┌──────────────┐ │ │ ┌──────────────┐ │ │ ┌──────────────┐                │ │
│  │ │    etcd      │◄├─┤►│    etcd      │◄├─┤►│    etcd      │ (Raft Cluster) │ │
│  │ │   (Leader)   │ │ │ │  (Follower)  │ │ │ │  (Follower)  │                │ │
│  │ └──────────────┘ │ │ └──────────────┘ │ │ └──────────────┘                │ │
│  │ 192.168.1.101    │ │ 192.168.1.102    │ │ 192.168.1.103                   │ │
│  └──────────────────┘ └──────────────────┘ └──────────────────────────────────┘ │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### HA 关键配置

| 组件 | HA 方式 | 配置 | 最小副本数 |
|------|---------|------|------------|
| **API Server** | 多副本 + LB | 无状态，可水平扩展 | 2 (推荐 3) |
| **etcd** | Raft 集群 | 奇数节点 (2f+1) | 3 (推荐 5) |
| **Scheduler** | Leader 选举 | `--leader-elect=true` | 2 (推荐 3) |
| **Controller Manager** | Leader 选举 | `--leader-elect=true` | 2 (推荐 3) |

#### kubeadm HA 部署示例

```bash
# Master-1 初始化 (第一个控制平面节点)
kubeadm init \
  --control-plane-endpoint "loadbalancer.example.com:6443" \
  --upload-certs \
  --pod-network-cidr=10.244.0.0/16

# Master-2/3 加入 (其他控制平面节点)
kubeadm join loadbalancer.example.com:6443 \
  --token <token> \
  --discovery-token-ca-cert-hash sha256:<hash> \
  --control-plane \
  --certificate-key <certificate-key>

# Worker 节点加入
kubeadm join loadbalancer.example.com:6443 \
  --token <token> \
  --discovery-token-ca-cert-hash sha256:<hash>
```

### 6.2 etcd 高可用配置

#### etcd 集群拓扑

| 节点数 | 容错能力 | 推荐场景 |
|--------|----------|----------|
| 1 | 0 (不可用) | 开发/测试 |
| 3 | 1 | 小型生产 |
| 5 | 2 | 大型生产 |
| 7 | 3 | 关键业务 (罕见) |

#### 备份与恢复

```bash
# etcd 快照备份
ETCDCTL_API=3 etcdctl snapshot save /backup/etcd-$(date +%Y%m%d).db \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key

# 验证快照
ETCDCTL_API=3 etcdctl snapshot status /backup/etcd-20260120.db --write-out=table

# 恢复 etcd (需停止 API Server)
ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-20260120.db \
  --data-dir=/var/lib/etcd-restore \
  --name=etcd-1 \
  --initial-cluster=etcd-1=https://192.168.1.101:2380,etcd-2=https://192.168.1.102:2380,etcd-3=https://192.168.1.103:2380 \
  --initial-advertise-peer-urls=https://192.168.1.101:2380

# 更新 etcd 数据目录
# /etc/kubernetes/manifests/etcd.yaml
# - --data-dir=/var/lib/etcd-restore
```

---

## 7. 扩展机制

### 7.1 Kubernetes 扩展点

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Kubernetes Extension Points                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────── API 层扩展 ───────────────────────────────────┐   │
│  │  1. CustomResourceDefinition (CRD)                                        │   │
│  │     - 定义自定义资源类型                                                  │   │
│  │     - 无需修改 API Server 代码                                            │   │
│  │     - 示例: Ingress, Prometheus CRD                                       │   │
│  │                                                                           │   │
│  │  2. API Aggregation (AA)                                                  │   │
│  │     - 扩展 Kubernetes API                                                 │   │
│  │     - 运行独立 API Server                                                 │   │
│  │     - 示例: metrics-server, service-catalog                               │   │
│  └───────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌─────────────────────────── 准入控制扩展 ─────────────────────────────────┐   │
│  │  3. MutatingAdmissionWebhook                                              │   │
│  │     - 修改资源对象                                                        │   │
│  │     - 示例: Istio Sidecar 注入                                            │   │
│  │                                                                           │   │
│  │  4. ValidatingAdmissionWebhook                                            │   │
│  │     - 验证资源对象                                                        │   │
│  │     - 示例: OPA/Gatekeeper 策略验证                                       │   │
│  └───────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌─────────────────────────── 运行时扩展 ───────────────────────────────────┐   │
│  │  5. Container Runtime Interface (CRI)                                     │   │
│  │     - containerd, CRI-O                                                   │   │
│  │                                                                           │   │
│  │  6. Container Network Interface (CNI)                                     │   │
│  │     - Calico, Cilium, Flannel                                             │   │
│  │                                                                           │   │
│  │  7. Container Storage Interface (CSI)                                     │   │
│  │     - AWS EBS CSI, Ceph CSI                                               │   │
│  │                                                                           │   │
│  │  8. Device Plugin                                                         │   │
│  │     - GPU (NVIDIA), RDMA, FPGA                                            │   │
│  └───────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌─────────────────────────── 调度扩展 ─────────────────────────────────────┐   │
│  │  9. Scheduler Framework Plugins                                           │   │
│  │     - 自定义 Filter/Score 插件                                            │   │
│  │                                                                           │   │
│  │  10. Scheduler Extender (已废弃)                                          │   │
│  │     - 外部 HTTP 调度器扩展                                                │   │
│  └───────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌─────────────────────────── 控制器扩展 ───────────────────────────────────┐   │
│  │  11. Operator Pattern                                                     │   │
│  │     - CRD + Controller 管理复杂应用                                       │   │
│  │     - 示例: Prometheus Operator, MySQL Operator                           │   │
│  └───────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 CRD 示例

```yaml
# 定义 CRD
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: databases.example.com
spec:
  group: example.com
  names:
    kind: Database
    listKind: DatabaseList
    plural: databases
    singular: database
    shortNames:
    - db
  scope: Namespaced
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              engine:
                type: string
                enum: ["mysql", "postgresql"]
              version:
                type: string
              replicas:
                type: integer
                minimum: 1
            required:
            - engine
            - version
          status:
            type: object
            properties:
              ready:
                type: boolean
    subresources:
      status: {}
    additionalPrinterColumns:
    - name: Engine
      type: string
      jsonPath: .spec.engine
    - name: Replicas
      type: integer
      jsonPath: .spec.replicas
    - name: Ready
      type: boolean
      jsonPath: .status.ready
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp

---
# 创建 CR 实例
apiVersion: example.com/v1
kind: Database
metadata:
  name: my-mysql
spec:
  engine: mysql
  version: "8.0"
  replicas: 3
```

### 7.3 Operator 模式

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             Operator Pattern                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │  1. 用户创建 CR (Custom Resource)                                      │     │
│  │     kubectl apply -f database.yaml                                     │     │
│  └────────────────────────────┬────────────────────────────────────────────┘     │
│                                ▼                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │  2. API Server 存储 CR 到 etcd                                          │     │
│  └────────────────────────────┬────────────────────────────────────────────┘     │
│                                ▼                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │  3. Operator Controller Watch CR 变化                                  │     │
│  │     - Informer 监听 Database 资源                                       │     │
│  │     - 触发 Reconcile 循环                                               │     │
│  └────────────────────────────┬────────────────────────────────────────────┘     │
│                                ▼                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │  4. Operator 调谐逻辑 (Reconciliation)                                 │     │
│  │     a. 对比当前状态 (Status) vs 期望状态 (Spec)                        │     │
│  │     b. 执行操作:                                                        │     │
│  │        - 创建 StatefulSet (数据库副本)                                 │     │
│  │        - 创建 Service (访问入口)                                        │     │
│  │        - 创建 PVC (持久化存储)                                          │     │
│  │        - 执行数据库初始化 (Job)                                         │     │
│  │     c. 更新 CR Status (就绪状态)                                        │     │
│  └────────────────────────────┬────────────────────────────────────────────┘     │
│                                ▼                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │  5. 持续监控与修复                                                      │     │
│  │     - Pod 故障 → 重建                                                   │     │
│  │     - 配置变更 → 滚动更新                                               │     │
│  │     - 扩缩容 → 调整 StatefulSet 副本                                    │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 安全架构

### 8.1 安全层次

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Security Defense-in-Depth                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────── Layer 1: 集群访问控制 ──────────────────────────┐  │
│  │  1. Authentication (认证)                                                  │  │
│  │     ├── X.509 Client Certificates (客户端证书)                            │  │
│  │     ├── Static Token Files (静态 Token)                                   │  │
│  │     ├── Bootstrap Tokens (引导 Token)                                     │  │
│  │     ├── Service Account Tokens (服务账户 Token)                           │  │
│  │     ├── OpenID Connect (OIDC)                                             │  │
│  │     └── Webhook Token Authentication                                      │  │
│  │                                                                            │  │
│  │  2. Authorization (授权)                                                   │  │
│  │     ├── RBAC (Role-Based Access Control) - 推荐                           │  │
│  │     ├── ABAC (Attribute-Based Access Control)                             │  │
│  │     ├── Node Authorization (节点授权)                                     │  │
│  │     └── Webhook Authorization                                             │  │
│  │                                                                            │  │
│  │  3. Admission Control (准入控制)                                          │  │
│  │     ├── PodSecurity (替代 PodSecurityPolicy)                              │  │
│  │     ├── MutatingAdmissionWebhook                                          │  │
│  │     ├── ValidatingAdmissionWebhook                                        │  │
│  │     └── ResourceQuota / LimitRanger                                       │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  ┌────────────────────────── Layer 2: 网络隔离 ─────────────────────────────┐  │
│  │  4. NetworkPolicy                                                          │  │
│  │     ├── Ingress/Egress 规则                                               │  │
│  │     ├── 命名空间隔离                                                       │  │
│  │     └── Pod 级防火墙                                                       │  │
│  │                                                                            │  │
│  │  5. Service Mesh mTLS                                                      │  │
│  │     ├── Istio / Linkerd                                                    │  │
│  │     └── 东西向流量加密                                                     │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  ┌────────────────────────── Layer 3: 容器安全 ─────────────────────────────┐  │
│  │  6. 镜像安全                                                               │  │
│  │     ├── 镜像签名验证 (Cosign/Notary)                                      │  │
│  │     ├── 镜像扫描 (Trivy/Clair)                                            │  │
│  │     └── 私有镜像仓库                                                       │  │
│  │                                                                            │  │
│  │  7. Runtime Security                                                       │  │
│  │     ├── Seccomp (系统调用过滤)                                            │  │
│  │     ├── AppArmor / SELinux                                                 │  │
│  │     ├── Capabilities Drop (能力剥离)                                      │  │
│  │     ├── User Namespaces (用户命名空间隔离)                                │  │
│  │     └── 安全容器 (gVisor/Kata)                                            │  │
│  │                                                                            │  │
│  │  8. Pod Security Standards                                                 │  │
│  │     ├── Privileged (特权模式)                                             │  │
│  │     ├── Baseline (基线)                                                   │  │
│  │     └── Restricted (受限模式) - 推荐                                      │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  ┌────────────────────────── Layer 4: 数据安全 ─────────────────────────────┐  │
│  │  9. Secrets Management                                                     │  │
│  │     ├── etcd 加密 (EncryptionConfiguration)                               │  │
│  │     ├── Secret 对象 (Base64 编码)                                         │  │
│  │     ├── Sealed Secrets (加密 Secret)                                      │  │
│  │     └── 外部 Secret 管理 (Vault/ESO)                                      │  │
│  │                                                                            │  │
│  │  10. Audit Logging                                                         │  │
│  │     ├── API 审计日志                                                       │  │
│  │     └── Falco 运行时审计                                                   │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 RBAC 权限模型

```yaml
# ClusterRole (集群级别)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pod-reader
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]

---
# Role (命名空间级别)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: deployment-manager
  namespace: production
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
# ClusterRoleBinding (集群级别绑定)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: read-pods-global
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: pod-reader
subjects:
- kind: User
  name: jane
  apiGroup: rbac.authorization.k8s.io

---
# RoleBinding (命名空间绑定)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: manage-deployments
  namespace: production
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: deployment-manager
subjects:
- kind: ServiceAccount
  name: cicd-deployer
  namespace: production
```

### 8.3 Pod Security Standards

| 级别 | 描述 | 限制 |
|------|------|------|
| **Privileged** | 无限制 | 允许已知的权限提升 |
| **Baseline** | 基线 | 阻止已知的权限提升，允许默认配置 |
| **Restricted** | 严格限制 | 强制执行当前 Pod 加固最佳实践 |

```yaml
# Namespace 级别应用 Pod Security
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

---

## 9. 监控与可观测性

### 9.1 可观测性三大支柱

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       Observability Three Pillars                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────── Metrics (指标) ─────────────────────────────────┐ │
│  │  - Prometheus (采集、存储、查询)                                            │ │
│  │  - Grafana (可视化)                                                         │ │
│  │  - 四大黄金信号: Latency (延迟), Traffic (流量), Errors (错误), Saturation (饱和度) │ │
│  │  - USE 方法: Utilization (利用率), Saturation (饱和度), Errors (错误)      │ │
│  │  - RED 方法: Rate (请求速率), Errors (错误率), Duration (请求时长)         │ │
│  └──────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  ┌─────────────────────────── Logging (日志) ─────────────────────────────────┐ │
│  │  - EFK (Elasticsearch + Fluentd + Kibana)                                   │ │
│  │  - ELK (Elasticsearch + Logstash + Kibana)                                  │ │
│  │  - Loki (Grafana Loki)                                                      │ │
│  │  - 日志级别: ERROR > WARN > INFO > DEBUG > TRACE                            │ │
│  └──────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  ┌─────────────────────────── Tracing (追踪) ─────────────────────────────────┐ │
│  │  - Jaeger / Zipkin                                                          │ │
│  │  - OpenTelemetry (统一标准)                                                 │ │
│  │  - 分布式追踪: Trace → Span → Context Propagation                          │ │
│  └──────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 核心监控指标

| 层次 | 指标类别 | 关键指标 | 采集方式 |
|------|----------|----------|----------|
| **控制平面** | API Server | `apiserver_request_duration_seconds`, `apiserver_request_total` | Prometheus /metrics |
| | etcd | `etcd_disk_backend_commit_duration_seconds`, `etcd_mvcc_db_total_size_in_bytes` | Prometheus /metrics |
| | Scheduler | `scheduler_scheduling_attempt_duration_seconds`, `scheduler_pending_pods` | Prometheus /metrics |
| | Controller Manager | `workqueue_depth`, `workqueue_queue_duration_seconds` | Prometheus /metrics |
| **节点** | Kubelet | `kubelet_pod_start_duration_seconds`, `kubelet_running_pods` | Prometheus /metrics |
| | cAdvisor | `container_cpu_usage_seconds_total`, `container_memory_working_set_bytes` | Prometheus /metrics |
| | Node Exporter | `node_cpu_seconds_total`, `node_memory_MemAvailable_bytes` | Prometheus /metrics |
| **应用** | Pod/Container | CPU/内存/网络/磁盘 I/O | cAdvisor |
| | Service | 请求速率/错误率/延迟 | Service Mesh / Application |

### 9.3 告警规则示例

```yaml
# Prometheus AlertRule
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernetes-alerts
  namespace: monitoring
spec:
  groups:
  - name: kubernetes-system
    interval: 30s
    rules:
    # API Server 告警
    - alert: KubeAPIDown
      expr: up{job="apiserver"} == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Kubernetes API Server is down"
        description: "API Server {{ $labels.instance }} is down for 5 minutes."

    - alert: APIServerLatencyHigh
      expr: histogram_quantile(0.99, apiserver_request_duration_seconds_bucket{verb!="WATCH"}) > 4
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "API Server latency is high"
        description: "P99 latency for {{ $labels.verb }} requests is {{ $value }}s"

    # etcd 告警
    - alert: EtcdNoLeader
      expr: etcd_server_has_leader == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "etcd has no leader"
        description: "etcd cluster has no leader for 1 minute."

    - alert: EtcdHighFsyncDuration
      expr: histogram_quantile(0.99, etcd_disk_backend_commit_duration_seconds_bucket) > 0.5
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "etcd fsync duration is high"
        description: "P99 fsync duration is {{ $value }}s"

    # 节点告警
    - alert: NodeNotReady
      expr: kube_node_status_condition{condition="Ready",status="true"} == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Node is not ready"
        description: "Node {{ $labels.node }} is not ready for 5 minutes."

    - alert: NodeMemoryPressure
      expr: kube_node_status_condition{condition="MemoryPressure",status="true"} == 1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Node has memory pressure"
        description: "Node {{ $labels.node }} has memory pressure."

    # Pod 告警
    - alert: PodCrashLooping
      expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "Pod is crash looping"
        description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is restarting frequently."

    - alert: PodNotReady
      expr: kube_pod_status_phase{phase!~"Running|Succeeded"} > 0
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "Pod is not ready"
        description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is in {{ $labels.phase }} phase for 15 minutes."
```

---

## 10. 生产实践案例

### 10.1 大规模集群优化

| 优化项 | 配置 | 效果 |
|--------|------|------|
| **API Server** | `--max-requests-inflight=400`, `--max-mutating-requests-inflight=200` | 提高并发处理能力 |
| | `--etcd-compaction-interval=5m` | 控制 etcd 压缩频率 |
| | `--event-ttl=1h` | 减少 Event 对象数量 |
| **etcd** | `--quota-backend-bytes=8GB` | 增加存储配额 |
| | `--heartbeat-interval=100`, `--election-timeout=1000` | 优化心跳与选举 |
| | 定期快照备份 | 灾难恢复 |
| **Scheduler** | `--kube-api-qps=100`, `--kube-api-burst=200` | 提高 API 请求 QPS |
| **kubelet** | `--max-pods=500` | 云环境单节点更多 Pod (AWS) |
| | `--image-gc-high-threshold=90`, `--image-gc-low-threshold=80` | 镜像垃圾回收 |
| **kube-proxy** | IPVS 模式 | 大规模 Service 性能 |

### 10.2 多租户隔离方案

```yaml
# 方案一: Namespace 隔离 (软隔离)
apiVersion: v1
kind: Namespace
metadata:
  name: tenant-a
  labels:
    tenant: a
---
# ResourceQuota (限制资源)
apiVersion: v1
kind: ResourceQuota
metadata:
  name: tenant-a-quota
  namespace: tenant-a
spec:
  hard:
    requests.cpu: "100"
    requests.memory: "200Gi"
    requests.storage: "1Ti"
    persistentvolumeclaims: "50"
    pods: "500"
---
# NetworkPolicy (网络隔离)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-other-namespaces
  namespace: tenant-a
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector: {}  # 只允许同命名空间

# 方案二: 虚拟集群 (硬隔离)
# - vcluster (虚拟 Kubernetes API Server)
# - Kamaji (Kubernetes 控制平面即服务)
```

### 10.3 容量规划参考

| 集群规模 | 节点数 | Pod 数 | Master 配置 | etcd 配置 |
|----------|--------|--------|-------------|-----------|
| **小型** | < 50 | < 1500 | 2C4G | 3 节点 (2C4G, SSD) |
| **中型** | 50-250 | 1500-7500 | 4C8G | 3 节点 (4C8G, SSD) |
| **大型** | 250-1000 | 7500-30000 | 8C16G | 5 节点 (8C16G, NVMe) |
| **超大型** | > 1000 | > 30000 | 16C32G | 5 节点 (16C32G, NVMe) |

### 10.4 灾难恢复检查清单

| 项目 | 备份内容 | 频率 | 存储位置 |
|------|----------|------|----------|
| **etcd 快照** | 集群状态 | 每小时 | 对象存储 (S3/OSS) |
| **证书备份** | /etc/kubernetes/pki | 每次变更 | 加密存储 |
| **配置备份** | kubeconfig, manifests | 每次变更 | Git 仓库 |
| **应用数据** | PV 数据 | 每天 (Velero) | 对象存储 |
| **恢复演练** | 完整集群重建 | 每季度 | - |

---

## 附录

### A. 版本兼容性

| Kubernetes 版本 | 支持的 kubelet 版本 | 支持的 kubectl 版本 | etcd 版本 |
|-----------------|---------------------|---------------------|-----------|
| 1.32 | 1.32, 1.31, 1.30 | 1.33, 1.32, 1.31 | 3.5.x |
| 1.31 | 1.31, 1.30, 1.29 | 1.32, 1.31, 1.30 | 3.5.x |
| 1.30 | 1.30, 1.29, 1.28 | 1.31, 1.30, 1.29 | 3.5.x |
| 1.29 | 1.29, 1.28, 1.27 | 1.30, 1.29, 1.28 | 3.5.x |
| 1.28 | 1.28, 1.27, 1.26 | 1.29, 1.28, 1.27 | 3.5.x |

### B. 端口参考

| 组件 | 端口 | 协议 | 说明 |
|------|------|------|------|
| API Server | 6443 | HTTPS | Kubernetes API |
| etcd | 2379 | HTTPS | 客户端通信 |
| etcd | 2380 | HTTPS | 集群间通信 |
| kubelet | 10250 | HTTPS | kubelet API |
| kubelet | 10255 | HTTP | 只读端口 (已废弃) |
| kube-scheduler | 10259 | HTTPS | 健康检查/指标 |
| kube-controller-manager | 10257 | HTTPS | 健康检查/指标 |
| kube-proxy | 10249 | HTTP | 指标 |

### C. 常用命令速查

```bash
# 集群信息
kubectl cluster-info
kubectl version
kubectl api-resources

# 节点管理
kubectl get nodes
kubectl describe node <node-name>
kubectl cordon <node-name>  # 标记不可调度
kubectl drain <node-name>   # 驱逐 Pod

# Pod 调试
kubectl get pods -o wide
kubectl describe pod <pod-name>
kubectl logs <pod-name> -c <container-name>
kubectl exec -it <pod-name> -- sh

# 资源查看
kubectl top nodes
kubectl top pods

# etcd 操作
ETCDCTL_API=3 etcdctl member list
ETCDCTL_API=3 etcdctl endpoint status
ETCDCTL_API=3 etcdctl endpoint health

# 证书检查
kubeadm certs check-expiration
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout
```

---

**表格底部标记**: Kusheet Project | 作者: Allen Galler (allengaller@gmail.com) | 参考: [Kubernetes 官方文档](https://kubernetes.io/docs/)
