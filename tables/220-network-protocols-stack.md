# 网络协议栈详解

> **适用版本**: TCP/IP 协议族 | **最后更新**: 2026-01

---

## 目录

- [网络模型对比](#网络模型对比)
- [OSI 七层模型](#osi-七层模型)
- [TCP/IP 四层模型](#tcpip-四层模型)
- [数据封装过程](#数据封装过程)
- [常用协议概览](#常用协议概览)
- [Linux 网络栈](#linux-网络栈)

---

## 网络模型对比

### OSI vs TCP/IP

```
┌─────────────────┐    ┌─────────────────┐
│   OSI 7层模型   │    │  TCP/IP 4层模型  │
├─────────────────┤    ├─────────────────┤
│  7. 应用层      │    │                 │
├─────────────────┤    │   应用层        │
│  6. 表示层      │    │   HTTP/DNS/SSH  │
├─────────────────┤    │                 │
│  5. 会话层      │    │                 │
├─────────────────┤    ├─────────────────┤
│  4. 传输层      │    │   传输层        │
│     TCP/UDP     │    │   TCP/UDP       │
├─────────────────┤    ├─────────────────┤
│  3. 网络层      │    │   网络层        │
│     IP/ICMP     │    │   IP/ICMP       │
├─────────────────┤    ├─────────────────┤
│  2. 数据链路层   │    │                 │
│     Ethernet    │    │   网络接口层     │
├─────────────────┤    │   Ethernet/ARP  │
│  1. 物理层      │    │                 │
└─────────────────┘    └─────────────────┘
```

---

## OSI 七层模型

| 层次 | 名称 | 功能 | 协议/设备 |
|:---:|:---|:---|:---|
| 7 | 应用层 | 网络应用接口 | HTTP, FTP, DNS, SSH |
| 6 | 表示层 | 数据格式转换 | SSL/TLS, JPEG, ASCII |
| 5 | 会话层 | 会话管理 | NetBIOS, RPC |
| 4 | 传输层 | 端到端传输 | TCP, UDP |
| 3 | 网络层 | 路由寻址 | IP, ICMP, 路由器 |
| 2 | 数据链路层 | 帧传输 | Ethernet, 交换机 |
| 1 | 物理层 | 比特传输 | 网线, 光纤, 集线器 |

---

## TCP/IP 四层模型

### 应用层

| 协议 | 端口 | 功能 |
|:---|:---:|:---|
| HTTP/HTTPS | 80/443 | Web 服务 |
| DNS | 53 | 域名解析 |
| SSH | 22 | 远程登录 |
| FTP | 21 | 文件传输 |
| SMTP | 25 | 邮件发送 |
| SNMP | 161 | 网络管理 |

### 传输层

| 协议 | 特点 | 使用场景 |
|:---|:---|:---|
| **TCP** | 可靠、有序、流控 | Web, SSH, 邮件 |
| **UDP** | 无连接、快速 | DNS, 视频, 游戏 |

### 网络层

| 协议 | 功能 |
|:---|:---|
| **IP** | 寻址和路由 |
| **ICMP** | 错误报告、ping |
| **ARP** | IP→MAC 解析 |
| **RARP** | MAC→IP 解析 |

### 网络接口层

| 协议/标准 | 功能 |
|:---|:---|
| **Ethernet** | 有线局域网 |
| **Wi-Fi** | 无线局域网 |
| **PPP** | 点对点协议 |

---

## 数据封装过程

```
发送端                                         接收端
┌───────────────┐                       ┌───────────────┐
│    应用层     │ ──── 数据 ────────►   │    应用层     │
├───────────────┤                       ├───────────────┤
│    传输层     │ ──── 段 ─────────►    │    传输层     │
│    TCP头+数据  │                       │               │
├───────────────┤                       ├───────────────┤
│    网络层     │ ──── 包 ─────────►    │    网络层     │
│  IP头+TCP头+数据│                       │               │
├───────────────┤                       ├───────────────┤
│   数据链路层   │ ──── 帧 ─────────►   │   数据链路层   │
│MAC头+IP头+TCP头+数据+FCS│               │               │
├───────────────┤                       ├───────────────┤
│    物理层     │ ──── 比特 ────────►   │    物理层     │
└───────────────┘                       └───────────────┘
```

### MTU 与分片

| 网络类型 | 典型 MTU |
|:---|:---:|
| Ethernet | 1500 |
| PPPoE | 1492 |
| VXLAN/GENEVE | 1450 |
| 隧道 | 1400-1450 |

```bash
# 查看 MTU
ip link show eth0 | grep mtu

# 设置 MTU
ip link set eth0 mtu 1450

# 测试 MTU
ping -M do -s 1472 target
```

---

## 常用协议概览

### IP 协议

| 字段 | 说明 |
|:---|:---|
| Version | 版本 (IPv4/IPv6) |
| TTL | 生存时间 |
| Protocol | 上层协议 (TCP=6, UDP=17) |
| Source IP | 源地址 |
| Dest IP | 目标地址 |

### ICMP 类型

| 类型 | 说明 |
|:---:|:---|
| 0 | Echo Reply (ping 响应) |
| 3 | Destination Unreachable |
| 5 | Redirect |
| 8 | Echo Request (ping 请求) |
| 11 | Time Exceeded |

### ARP 工作流程

```
1. 主机 A 需要发送数据给 IP_B
2. 检查 ARP 缓存，无 IP_B 的 MAC
3. 广播 ARP Request: "谁是 IP_B?"
4. IP_B 回复 ARP Reply: "我是 IP_B，MAC 是..."
5. A 缓存 IP_B→MAC_B 映射
6. 发送数据帧到 MAC_B
```

```bash
# 查看 ARP 缓存
arp -n
ip neigh show

# 清除 ARP 缓存
ip neigh flush all
```

---

## Linux 网络栈

### 网络栈架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户空间                                 │
│  应用程序 (socket API)                                          │
└───────────────────────────┬─────────────────────────────────────┘
                            │ 系统调用
┌───────────────────────────┴─────────────────────────────────────┐
│                         内核空间                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Socket 层                                                │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  传输层 (TCP/UDP)                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Netfilter (iptables/nftables)                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  网络层 (IP 路由)                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  网络设备驱动                                             │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 查看网络配置

```bash
# 接口信息
ip addr show
ip link show

# 路由表
ip route show

# 连接状态
ss -tunap

# 网络统计
netstat -s
nstat
```

---

## 相关文档

- [221-tcp-udp-deep-dive](./221-tcp-udp-deep-dive.md) - TCP/UDP 详解
- [222-dns-principles-configuration](./222-dns-principles-configuration.md) - DNS 原理
- [213-linux-networking-configuration](./213-linux-networking-configuration.md) - Linux 网络配置
